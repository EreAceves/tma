---
title: "Fishery Model"
date: "`r Sys.Date()`"
output: html_document
---

```{r pkg_ins, include = FALSE}

rm(list=ls())

# Check out knitr for knitr::read_chunk.
library(knitr)

# Name packages.
pkg <- c("readr",
         "knitr",
         "tidyverse",
         "gapminder",
         "sandwich",
         "broom",
         "stargazer",
         "cowplot",
         "kableExtra",
         "reshape2",
         "devtools")

# Install packages.
#install.packages(pkg, verbose = FALSE, quiet = TRUE)
#devtools::install_github("AckerDWM/gg3D")
  
# Update packages.
update.packages(pkg, verbose = FALSE, quiet = TRUE)

# Check out packages.
lapply(pkg, library, character.only = TRUE)

#library(gg3D)

```

#####Objective: Step through optimal aggregate harvest in an open access fishery.
Swap out toy model for INAPESCA's age-structured model. 

##### Dynamic Stock and Harvest, w/ Age Structure, w/o Parameterization

Looking for:
Matrices:
Numbers at Age by Year
Total Weights at Age by Year
Total Fecundities at Age by Year

Vectors:
Initial Numbers at Age
Individual Lengths at Age
Individual Weights at Age
Individual Fecundities at Age
Proportional Natural Mortalities at Age
Proportional Poaching Selectivities at Age
Proportional Bycatch Selectivities at Age


Toy Version:

```{r age_struct_toy}

# Matrix of numbers at age by year.
mat_a = matrix(nrow = 10, ncol = 5)

# Vector for initial n at a.
v_init = seq(5, 1)

# Vectors for proportional mortalities by age. NB: Survival, not mortality.
v_mort_first = 0.5
v_mort_rest = c(0.85, 0.875, 0.90, 1)

# Vector for proportional fecundities at age. Each fecund fish returns two fish. 
v_fec_rest = rep(0.25, 4)

# Plug initial numbers into the matrix.
mat_a[1,] = v_init

# Run one-shot test.
mat_a[2, 2:5] = mat_a[1, 1:4] * v_mort_rest
mat_a[2, 1] = sum(mat_a[1, 2:5] * v_fec_rest * 3)

# Set up first test.
fun_test = function(nrow, ncol){
                                mat_a = matrix(nrow = nrow, ncol = ncol)
                                v_init = seq(5, 1)
                                v_mort_first = 0.5
                                v_mort_rest = c(0.85, 0.875, 0.90, 1)
                                v_fec_rest = rep(0.25, 4)
                                mat_a[1,] = v_init
                                for(i in 2:nrow){mat_a[i, 2:5] = mat_a[i - 1, 1:4] * v_mort_rest
                                                 mat_a[i, 1] = sum(mat_a[i - 1, 2:5] * v_fec_rest * 3)/(1 + mat_a[i - 1, 1] / 250)}
                                  
                                return(mat_a)}

# Run first test.
uh = fun_test(50, 5)

duh = data.frame(uh)

mut = mutate(duh, t = seq(0, 49))

melt = reshape2::melt(mut, id.vars = "t")

ggplot(melt, aes(t, value, color = variable)) +
  geom_line()

```

Totoaba Version:

```{r age_struct_tma_mat}

# Matrix of numbers at age by year.
mat_a = matrix(nrow = 50, ncol = 30)

```

```{r age_struct_tma_ninit}

# Vector for initial n at a.
#  Assign initial biomass from INAPESCA estimate.
#  Try the lower bound on the 95% CI of INAPESCA's 2017 estimate from surveys.
biomass_init = 25709000 # kilograms.

#  Assign functional form for frequencies at age from True (2018). See notes on symposium presentation. Check whether curve describes numbers at age.
fun_a_n = function(a){121.99 * 10 ^ (-0.214 * a)}

#  Convert numbers at age to sums of weights at age to work from total biomass back to numbers at age.
fun_a_l = function(a, linf, k, t0){l = linf * (1 - exp(-k * (a - t0)))} # INAPESCA (2018): 200, 0.155, -0.65. See notes for alternatives.
fun_l_w = function(a, l, b){w = a * l ^ b} # INAPESCA (2018) / Anda-Monta単ez et al. (2013): 0.000005, 3.0635. See notes for alternatives.

# Calculations:
#  Vector of ages.
a = seq(0, 29)
#  Vector of lengths.
l = fun_a_l(a, 200, 0.155, -0.65)
#  Vector of weights.
w = fun_l_w(0.000005, l, 3.0635)
#  Numbers at age.
afreq = fun_a_n(a)
#  Weights at age.
wfreq = afreq * w
#  Weights at age, but useful.
winit = wfreq * (1 / sum(wfreq)) * biomass_init
#  Numbers at age to seed the model. That wasn't so hard, right?
ninit = winit / w
plot(ninit)

```

```{r age_struct_tma_natmort}

# Vector for proportional natural mortalities at age. NB: Survival, not mortality. From INAPESCA (2018) / Cisneros-Mata et al. (1995).
v_mort = rep(0.78, 30)

```

```{r age_struct_tma_fismort}
# Vector for proportional poaching mortalities at age.
#  Read in values for size-selective poaching from INAPESCA (2018); n = 1147 from 9 periods, 1963 - 2017.
v_select_data = 
  c(6, 9, 15, 60, 191, 281, 165, 133, 82, 33, 27, 21, 17, 10, 12, 16, 8, 15, 9, 12, 7, 9, 5, 2, 2, 0) %>% 
  data.frame() %>% 
  mutate(age = seq(1, 26)) %>% 
  rename(n = ".")

#  Estimate fit for a Weibull probability density function, because the internet said so. Try weibull.com/hotwire/issue14/relbasics14.htm
nls_select = nls(v_select_data$n ~ ifelse(is.na(x * (a / b) * ((v_select_data$age - c) / b) ^ (a - 1) * exp(-((v_select_data$age - c) / b ) ^ a)),
                                          0,
                                          x * (a / b) * ((v_select_data$age - c) / b) ^ (a - 1) * exp(-((v_select_data$age - c) / b ) ^ a)),
                 v_select_data, 
                 start = list(x = 3000, a = 2.5, b = 10, c = -3), 
                 lower = list(0, 0, 0, -Inf),
                 algorithm = "port")

#  Tibbulate nonlinear estimation.
nls_tidy = tidy(nls_select)

#  Plot fit against actual values.
fun_select = function(x, a, b, c, t){n = ifelse(is.na(x * (a / b) * ((t - c) / b) ^ (a - 1) * exp(-((t - c) / b ) ^ a)),
                                                0,
                                                x * (a / b) * ((t - c) / b) ^ (a - 1) * exp(-((t - c) / b ) ^ a))
                                     return(n)}

v_select_fit = fun_select(nls_tidy$estimate[1], nls_tidy$estimate[2], nls_tidy$estimate[3], nls_tidy$estimate[4], seq(1, 26))

ggplot() + 
  geom_point(aes(seq(1, 26), v_select_fit), color = "Red") + 
  geom_point(aes(seq(1, 26), v_select_data$n), color = "Green")

#  Consider fixing the upper tail. Those residuals probably matter.

#  Use parameters to restate the function on a single dimension (age) for integration.
simple_fun_select = function(t){n = 
                                ifelse(is.na(nls_tidy$estimate[1] * (nls_tidy$estimate[2] / nls_tidy$estimate[3]) * ((t - nls_tidy$estimate[4]) / nls_tidy$estimate[3]) ^ (nls_tidy$estimate[2] - 1) * exp(-((t - nls_tidy$estimate[4]) / nls_tidy$estimate[3] ) ^ nls_tidy$estimate[2])),
                                0,
                                nls_tidy$estimate[1] * (nls_tidy$estimate[2] / nls_tidy$estimate[3]) * ((t - nls_tidy$estimate[4]) / nls_tidy$estimate[3]) ^ (nls_tidy$estimate[2] - 1) * exp(-((t - nls_tidy$estimate[4]) / nls_tidy$estimate[3] ) ^ nls_tidy$estimate[2]))
                                return(n)}

#  Integrate over ages of interest. Those should probably be a universal parameter at this point. Consider fixing.
int_select = integrate(simple_fun_select, lower = 0, upper = 29)

#  Transform fitted values for poaching selectivity into a probability distribution function using the integral of the unidimensional function.
v_select_pdf = fun_select(nls_tidy$estimate[1], nls_tidy$estimate[2], nls_tidy$estimate[3], nls_tidy$estimate[4], seq(0, 29)) * 1 / int_select$value

#  Transform 2017 catch into 2017 catch-at-age in weight, then transform that sucker into catch-at-age in numbers, then make it proportions again.
#  Make this comment better.
catch = 1400000 # kilograms from tonnes. INAPESCA (2018).
v_select_n = catch * v_select_pdf / w # Check your conversion! You did this in the middle of the night, check it!
v_select_use = v_select_n/ninit # Diagnostic plot indicates you should really, really fix the residuals on the selectivity estimation.

```

```{r age_struct_tma_bycmort}

# Value for proportional bycatch mortalities at age.
bymort_init = 80000 # INAPESCA (2018) - estimated for 2011 - 2017 by some sort of credible method, probably.
bymort = 1 - bymort_init / ninit[2] # Instead of distributing bycatch mortalities, we concentrate them on one age (1) for lack of length-at-age resolution.

```

```{r age_struct_tma_fec}

# Vector for proportional fecundities at age. From INAPESCA (2018) / Valenzuela-Qui単onez (2014).
#  Set function.
fun_fec = function(l){1 / ( 1 + exp(-0.0099 * ((l - 1333.31) * 10)))}
#  Transform vector of lengths at age to fecundities.
v_fec = fun_fec(l)

# Vector for production of fecund hembras at age by way of length.
#  Set function for eggs per kilogram of total weight of mature fish.
fun_eggs = function(l){221.76 * exp(0.0047 * l)} # Valenzuela-Qui単onez (2014); used with Anda-Monta単ez et al. (2013) for mean by INAPESCA (2018).

#  Get values corresponding to vector of lengths.
v_eggs_l = fun_eggs(l)

#  Get values corresponding to vector of weights - this works out to be egg production at age before accounting for maturation.
v_eggs_w = v_eggs_l * w

# So account for maturation and survival, dummy. Survival from egg to juvenile from INAPESCA (2018). Reference against True (2018).
v_eggs_surv = 0.3 * 0.9 * 0.95 * 0.1
v_eggs = v_eggs_w * v_fec * v_eggs_surv

```

```{r age_struct_tma_ENTER_THE_MATRIX}
# Plug initial numbers into the matrix.
mat_a[1,] = ninit

# Set up first test.
fun_test = function(nrow, ncol, ninit, v_mort, bymort, v_select_use, v_eggs, k){
                                mat_a = matrix(nrow = nrow, ncol = ncol)
                                mat_a[1,] = ninit
                                for(i in 2:nrow){mat_a[i, 3:30] = mat_a[i - 1, 2:29] * v_mort[3:30] * (1 - v_select_use[3:30])
                                                 mat_a[i, 2] = mat_a[i - 1, 2] * v_mort[2] * bymort * (1 - v_select_use[2])
                                                 mat_a[i, 1] = sum(mat_a[i - 1, 1:30] * v_eggs)/(1 + mat_a[i - 1, 1] / k)}
                                  
                                return(mat_a)}

```

```{r age_struct_tma_run}

# Run first test.
uh = fun_test(10, 30, ninit, v_mort, bymort, v_select_use, v_eggs, 5000000)

```

```{r age_struct_tma_ploots}

duh = data.frame(uh) %>% 
  mutate(t = seq(0, 9)) %>% 
  melt(id.vars = "t")

try_age =
ggplot(duh, aes(t, value, color = variable)) +
  geom_line()

muh = data.frame(uh) %>% 
  mutate(t = seq(0, 9)) %>% 
  melt(id.vars = "t") %>%
  group_by(t) %>% 
  summarise(s = sum(value))

try_sum = 
ggplot(muh, aes(t, s)) +
  geom_line()

huh = muh %>%
  mutate(b = ifelse(t < 5, s, s + t * 100000))

try_hum = 
ggplot(huh) +
  geom_ribbon(aes(t, ymin = s, ymax = b), color = "midnightblue", alpha = 0.25) +
  geom_line(aes(t, b), color = "midnightblue") +
  geom_line(aes(t, s), color = "firebrick4")

```

```{r otherploots}
melt$variable = str_remove(melt$variable, "X")
melt$variable = as.numeric(melt$variable)

try3 = 
ggplot(melt, aes(x = variable, z = value, y = t, color = variable)) +
  ggtitle("Numbers at Age for 25 Years, Ages 1 - 30") +
  theme_void() + 
  theme(legend.position = "none") +
  #axes_3D() + 
  stat_3D(geom = "point", phi = 45, theta = 135) +
  scale_color_distiller(palette = "RdBu")

tryfirst = 
ggplot(filter(melt, variable == 1), aes(x = variable, z = value, y = t, color = variable)) +
  ggtitle("Numbers at Age for 25 Years, Ages 1 - 30") +
  theme_void() + 
  theme(legend.position = "none") +
  #axes_3D() + 
  stat_3D(geom = "point", phi = 45, theta = 135) +
  scale_color_distiller(palette = "RdBu")

trysecond = 
ggplot(filter(melt, variable < 11 & variable > 1), aes(x = variable, z = value, y = t, color = variable)) +
  ggtitle("Numbers at Age for 25 Years, Ages 2 - 10") +
  theme_void() + 
  theme(legend.position = "none",
        plot.title = element_text(size = 8)) +
  #axes_3D() + 
  stat_3D(geom = "point", phi = 45, theta = 135) +
  scale_color_distiller(palette = "Purples")

trythird = 
ggplot(filter(melt, variable < 21 & variable > 10), aes(x = variable, z = value, y = t, color = variable)) +
  ggtitle("Numbers at Age for 25 Years, Ages 11 - 20") +
  theme_void() + 
  theme(legend.position = "none",
        plot.title = element_text(size = 8)) +
  #axes_3D() + 
  stat_3D(geom = "point", phi = 45, theta = 135) +
  scale_color_distiller(palette = "Reds")

tryfourth = 
ggplot(filter(melt, variable < 31 & variable > 20), aes(x = variable, z = value, y = t, color = variable)) +
  ggtitle("Numbers at Age for 25 Years, Ages 21 - 30") +
  theme_void() + 
  theme(legend.position = "none",
        plot.title = element_text(size = 8)) +
  #axes_3D() + 
  stat_3D(geom = "point", phi = 45, theta = 135) +
  scale_color_distiller(palette = "Oranges")

ggsave("f1plot.png", plot = trysecond, dpi = 300, width = 3.25, height = 4.5)
ggsave("f2plot.png", plot = trythird, dpi = 300, width = 3.25, height = 4.5)
ggsave("f3plot.png", plot = tryfourth, dpi = 300, width = 3.25, height = 4.5)

```

